<?php
/**
 * PHPMailer - PHP email creation and transport class.
 * Minimal version for SMTP support
 */
class PHPMailer {
    public $From = '';
    public $FromName = '';
    public $Subject = '';
    public $Body = '';
    public $AltBody = '';
    public $Host = 'mail.stposta.com';
    public $Port = 465;
    public $SMTPAuth = true;
    public $Username = 'info@tamaksesuar.com';
    public $Password = '';
    public $SMTPSecure = 'ssl';
    public $CharSet = 'UTF-8';
    public $isHTML = true;
    
    private $to = [];
    private $replyTo = [];
    
    public function addAddress($email, $name = '') {
        $this->to[] = ['email' => $email, 'name' => $name];
    }
    
    public function addReplyTo($email, $name = '') {
        $this->replyTo[] = ['email' => $email, 'name' => $name];
    }
    
    public function send() {
        try {
            // SSL bağlantısı (465 port için ssl:// prefix gerekli)
            $remote = ($this->Port == 465) ? "ssl://{$this->Host}" : $this->Host;
            $smtp = fsockopen($remote, $this->Port, $errno, $errstr, 30);
            if (!$smtp) {
                throw new Exception("SMTP bağlantısı başarısız: $errstr ($errno)");
            }
            
            // SMTP komutları
            $this->readResponse($smtp);
            $ehlo = $_SERVER['SERVER_NAME'] ?? 'localhost';
            $this->sendCommand($smtp, "EHLO {$ehlo}");
            
            if ($this->SMTPAuth) {
                $this->sendCommand($smtp, "AUTH LOGIN");
                $this->sendCommand($smtp, base64_encode($this->Username));
                $this->sendCommand($smtp, base64_encode($this->Password));
            }
    private function readResponse($smtp){
        $resp = '';
        while ($line = fgets($smtp, 515)) {
            $resp .= $line;
            if (substr($line, 3, 1) === ' ') break;
        }
        return $resp;
    }

    private function sendCommand($smtp, $command){
        $this->logLine('C', $command);
        fwrite($smtp, $command . "\r\n");
        $resp = $this->readResponse($smtp);
        $this->logLine('S', $resp);
        return $resp;
    }

    private function expect($resp, $codes = ['250','235','354','220','221']){
        foreach ($codes as $c) {
            if (strpos($resp, $c) === 0) return true;
        }
        throw new Exception("SMTP beklenmeyen cevap: " . trim((string)$resp));
    }

    public function send() {
        if (empty($this->to)) {
            throw new Exception("En az bir alıcı gerekli.");
        }

        $useTLS = (strtolower($this->SMTPSecure) === 'tls');
        
        if ($useTLS) {
            // TLS için normal bağlantı, sonra STARTTLS
            $remote = $this->Host;
            $this->logLine('I', "CONNECT {$remote}:{$this->Port}");
            $errno = 0;
            $errstr = '';
            $smtp = @fsockopen($remote, $this->Port, $errno, $errstr, 30);
            
            if (!$smtp) {
                $this->logLine('E', "SOCKET FAIL errno=$errno err=$errstr");
                throw new Exception("SMTP bağlantısı başarısız: $errstr ($errno)");
            }

            $greet = $this->readResponse($smtp);
            $this->logLine('S', $greet);
            $this->expect($greet, ['220']);

            $ehloHost = $_SERVER['SERVER_NAME'] ?? 'vivarel.com.tr';
            $this->expect($this->sendCommand($smtp, "EHLO " . $ehloHost));

            // STARTTLS
            $this->logLine('I', 'Sending STARTTLS');
            $this->expect($this->sendCommand($smtp, "STARTTLS"), ['220']);
            
            // TLS şifreleme
            $this->logLine('I', 'Enabling TLS encryption');
            if (!stream_socket_enable_crypto($smtp, true, STREAM_CRYPTO_METHOD_TLS_CLIENT)) {
                throw new Exception("TLS şifreleme başarısız");
            }
            
            // TLS sonrası tekrar EHLO
            $this->expect($this->sendCommand($smtp, "EHLO " . $ehloHost));

        } else {
            // SSL için
            $remote = "ssl://{$this->Host}";
            $this->logLine('I', "CONNECT {$remote}:{$this->Port}");
            $errno = 0;
            $errstr = '';
            $smtp = @fsockopen($remote, $this->Port, $errno, $errstr, 30);
            
            if (!$smtp) {
                $this->logLine('E', "SOCKET FAIL errno=$errno err=$errstr");
                throw new Exception("SMTP bağlantısı başarısız: $errstr ($errno)");
            }

            $greet = $this->readResponse($smtp);
            $this->logLine('S', $greet);
            $this->expect($greet, ['220']);

            $ehloHost = $_SERVER['SERVER_NAME'] ?? 'vivarel.com.tr';
            $this->expect($this->sendCommand($smtp, "EHLO " . $ehloHost));
        }

        // AUTH LOGIN
        if ($this->SMTPAuth) {
            $this->expect($this->sendCommand($smtp, "AUTH LOGIN"), ['334']);
            $this->expect($this->sendCommand($smtp, base64_encode($this->Username)), ['334']);
            $this->expect($this->sendCommand($smtp, base64_encode($this->Password)), ['235']);
        }

        // Envelope
        $this->expect($this->sendCommand($smtp, "MAIL FROM:<{$this->From}>"));
        
        foreach ($this->to as $r) {
            $this->expect($this->sendCommand($smtp, "RCPT TO:<{$r['email']}>"), ['250','251']);
        }
        
        $this->expect($this->sendCommand($smtp, "DATA"), ['354']);

        // Headers
        $toHeader = implode(', ', array_map(
            fn($r) => $r['name'] ? "{$r['name']} <{$r['email']}>" : $r['email'], 
            $this->to
        ));
        
        $date = date('r');
        $mid = sprintf('<%s@%s>', 
            bin2hex(random_bytes(8)), 
            parse_url('https://' . ($ehloHost ?? 'localhost'), PHP_URL_HOST) ?: 'localhost'
        );

        $headers  = "From: {$this->FromName} <{$this->From}>\r\n";
        $headers .= "To: {$toHeader}\r\n";
        $headers .= "Subject: {$this->Subject}\r\n";
        $headers .= "Date: {$date}\r\n";
        $headers .= "Message-ID: {$mid}\r\n";
        $headers .= "MIME-Version: 1.0\r\n";
        $headers .= "Content-Transfer-Encoding: 8bit\r\n";
        
        if (!empty($this->replyTo)) {
            $r = $this->replyTo[0];
            $headers .= "Reply-To: " . ($r['name'] ? "{$r['name']} <{$r['email']}>" : $r['email']) . "\r\n";
        }
        
        $ctype = $this->isHTML ? "text/html" : "text/plain";
        $headers .= "Content-Type: {$ctype}; charset={$this->CharSet}\r\n\r\n";

        // Body normalize + dot-stuffing
        $body = str_replace(["\r\n", "\r"], "\n", $this->Body);
        $body = preg_replace('/^\./m', '..', $body);
        $body = str_replace("\n", "\r\n", $body);

        $this->logLine('C', '[DATA headers+body+DOT]');
        fwrite($smtp, $headers . $body . "\r\n.\r\n");
        
        $resp = $this->readResponse($smtp);
        $this->logLine('S', $resp);
        $this->expect($resp, ['250']);

        $this->expect($this->sendCommand($smtp, "QUIT"), ['221']);
        fclose($smtp);
        
        return true;
    }
}