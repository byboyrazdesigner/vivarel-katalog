// == SEPET MODAL + CSV BAĞLANTI (in5 Resources → JavaScript) ==(function() {    // --- Modal HTML'ini en sona ekle ---    const modalHTML = `  <div id="cart-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;">    <div id="cart-modal-card" style="max-width:560px; margin:6vh auto; background:#fff; border-radius:12px; padding:20px;">      <div style="display:flex; justify-content:space-between; align-items:center;">        <h3 id="pm-title" style="font-size:18px; font-weight:700; margin:0;"></h3>        <button id="pm-close" aria-label="Kapat" style="border:none; background:transparent; font-size:20px; cursor:pointer;">×</button>      </div>      <p id="pm-brand" style="margin:.5rem 0 0; color:#555;"></p>      <p id="pm-features" style="margin:.25rem 0 1rem; color:#666;"></p>      <div id="pm-variants"></div>      <div style="display:flex; gap:8px; align-items:center; margin-top:12px;">        <button id="pm-dec" style="width:36px; height:36px;">−</button>        <input id="pm-qty" type="number" min="1" value="1" style="width:64px; text-align:center;" />        <button id="pm-inc" style="width:36px; height:36px;">+</button>        <div id="pm-price" style="margin-left:auto; font-weight:700;"></div>      </div>      <div style="display:flex; gap:12px; margin-top:16px;">        <button id="pm-add" style="flex:1; height:44px; background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer;">Sepete Ekle</button>        <button id="pm-cancel" style="height:44px; background:#e5e7eb; border:none; border-radius:8px; cursor:pointer;">Vazgeç</button>      </div>    </div>  </div>`    ;    document.addEventListener("DOMContentLoaded", () => {        document.body.insertAdjacentHTML("beforeend", modalHTML);        initCartModal();    });    async function initCartModal() {        const CSV_URL = "tem_16_zone_sepet_butonlari.csv"; // export kökünde olmalı        const csvText = await fetch(CSV_URL, {            cache: "no-store"        }).then(r => r.text());        const rows = csvText.split(/\r?\n/).filter(l => l.trim()).map(csvRowSplit);        const headers = rows.shift().map(h => h.trim());        const data = rows.map(cols => {            const obj = {};            headers.forEach((h, i) => obj[h] = (cols[i] ?? "").trim());            if (obj.price_value)                obj.price_value = Number(String(obj.price_value).replace(",", "."));            obj.has_variants = obj.has_variants === "1" || obj.product_type === "variant";            return obj;        });        const bySelector = {};        for (const r of data)            if (r.button_selector)                bySelector[r.button_selector] = r;        const modal = document.getElementById("cart-modal");        const title = document.getElementById("pm-title");        const brand = document.getElementById("pm-brand");        const features = document.getElementById("pm-features");        const variantsBox = document.getElementById("pm-variants");        const qty = document.getElementById("pm-qty");        const dec = document.getElementById("pm-dec");        const inc = document.getElementById("pm-inc");        const price = document.getElementById("pm-price");        const addBtn = document.getElementById("pm-add");        const cancel = document.getElementById("pm-cancel");        const closeX = document.getElementById("pm-close");        let current = null,            selectedIdx = 0;        function fmtPrice(row) {            if (row.price_display)                return row.price_display;            if (row.price_value && row.price_currency) {                try {                    return new Intl.NumberFormat('tr-TR', {                        style: 'currency',                        currency: row.price_currency                    }).format(row.price_value);                }                catch {                    return new Intl.NumberFormat('tr-TR', {                        style: 'currency',                        currency: 'TRY'                    }).format(row.price_value);                }            }            return "";        }        function openModal(row) {            current = row;            selectedIdx = 0;            qty.value = row.default_qty || 1;            title.textContent = row.product_name || row.sku || "Ürün";            brand.textContent = row.brand ? `Marka: ${row.brand}` : "";            features.textContent = row.features || "";            price.textContent = fmtPrice(row);            variantsBox.innerHTML = "";            if (row.has_variants) {                const axes = (row.variant_axes || "").split("|").map(s => s.trim()).filter(Boolean);                const pairs = (row.variant_options || "").split("|").map(s => s.trim());                const matrix = axes.map((axis, i) => {                    const [k, vals] = pairs[i]?.split("=") ?? [axis, ""];                    return {                        axis,                        list: (vals || "").split(",").map(s => s.trim()).filter(Boolean)                    };                });                const selects = [];                matrix.forEach(({axis, list}) => {                    const label = document.createElement("label");                    label.style.display = "block";                    label.style.margin = "8px 0 4px";                    label.textContent = axis;                    const sel = document.createElement("select");                    sel.style.width = "100%";                    list.forEach(v => {                        const opt = document.createElement("option");                        opt.value = v;                        opt.textContent = v;                        sel.appendChild(opt);                    });                    sel.addEventListener("change", updateIdx);                    variantsBox.appendChild(label);                    variantsBox.appendChild(sel);                    selects.push(sel);                });                function updateIdx() {                    const sizes = matrix.map(m => m.list.length);                    const coords = selects.map((sel, i) => matrix[i].list.indexOf(sel.value));                    let idx = 0,                        mult = 1;                    for (let i = sizes.length - 1; i >= 0; i--) {                        idx += coords[i] * mult;                        mult *= sizes[i];                    }                    selectedIdx = idx;                }                updateIdx();            }            modal.style.display = "block";        }        function closeModal() {            modal.style.display = "none";            current = null;        }        dec.onclick = () => {            const m = Number(current?.min_qty || 1);            qty.value = Math.max(m, Number(qty.value || 1) - 1);        };        inc.onclick = () => {            qty.value = Number(qty.value || 1) + 1;        };        cancel.onclick = closeModal;        closeX.onclick = closeModal;        modal.addEventListener("click", (e) => {            if (e.target === modal)                closeModal();        });        addBtn.onclick = () => {            if (!current)                return;            const cart = JSON.parse(localStorage.getItem("demo_cart") || "[]");            let sku = current.sku;            if (current.has_variants) {                const list = (current.variant_skus || "").split(",").map(s => s.trim()).filter(Boolean);                sku = list[selectedIdx] || sku;            }            cart.push({                sku,                brand: current.brand,                name: current.product_name || current.sku,                qty: Number(qty.value || 1),                price: current.price_value || null,                currency: current.price_currency || "TRY",                ts: Date.now()            });            localStorage.setItem("demo_cart", JSON.stringify(cart));            alert("Sepete eklendi.");            closeModal();        };        // Butonları bağla (ID ile)        Object.entries(bySelector).forEach(([sel, row]) => {            const el = document.querySelector(sel);            if (!el)                return;            el.style.cursor = "pointer";            el.addEventListener("click", (ev) => {                ev.preventDefault();                openModal(row);            });        });        // Basit CSV satır ayırma (virgül bazlı; tırnaklı alan yoksa yeterli)        function csvRowSplit(line) {            // in5 export kökünde UTF-8-SIG CSV kullanıldı.            // Basit split: tırnaklı-virgüllü alan yoksa güvenli.            return line.split(",");        }    }})();